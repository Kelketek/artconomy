FROM python:3.11-alpine

# Override these if your local user has a different UID/GID.
ARG USER_UID=1000
ARG GROUP_GID=1000

# replace this with your application's default port
EXPOSE 8001
EXPOSE 8002
# Install essential packages, plus a few packages for live diagnosis if needed.
RUN apk add bash cargo elfutils-dev geoip gettext git libc-dev linux-headers libmaxminddb-dev libmaxminddb musl-dev ncurses-dev postgresql14-client postgresql14-dev vim
RUN addgroup -S app -g ${GROUP_GID}
RUN adduser -S app -G app -h /home/app -s /bin/bash -u ${USER_UID}
# Main dependencies
RUN mkdir /home/app/artconomy
RUN mkdir /home/app/static
RUN mkdir /home/app/media
WORKDIR /home/app
ENV LANG C.UTF-8
ENV HOME /home/app
ENV PATH $PATH:$HOME/.local/bin
WORKDIR /home/app/artconomy/
ADD . .
RUN chown -R app:app /home/app
WORKDIR /home/app/artconomy/rust/line_items
RUN pip install maturin
RUN maturin sdist
WORKDIR /home/app/artconomy/
RUN pip install --upgrade pip
RUN pip install pip-tools
# Needed for uwsgi to build under Alpine.
RUN pip install -r /home/app/artconomy/requirements.txt
USER app
