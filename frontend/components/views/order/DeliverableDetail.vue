<template>
  <ac-load-section :controller="deliverable">
    <template v-slot:default>
      <v-container v-if="deliverable.x && order.x">
        <v-row>
          <v-col>
            <v-card>
              <v-card-title><h3>Now what?</h3></v-card-title>
              <ac-form>
                <ac-form-container @submit.prevent="stateChange.submitThen(updateDeliverable)"
                                   :errors="stateChange.errors" :sending="stateChange.sending">
                  <v-card-text>
                    <v-row dense>
                      <v-col v-if="is(LIMBO) && isBuyer" cols="12">
                        <p>The artist has been informed about your order and should respond soon.</p>
                      </v-col>
                      <v-col v-if="is(WAITING) && isBuyer" cols="12">
                        <p>Your order has been placed in the artist's waitlist. Waitlisted orders are not guaranteed by
                          Artconomy to be accepted in any order and every artist's policy is different in how they are
                          handled.
                          If your artist has not listed their waitlist policy for this commission in the product
                          details,
                          or in their commission info under the Overview tab, you may want to message them for
                          clarification.</p>
                      </v-col>
                      <v-col v-if="is(WAITING) && isSeller && seller" cols="12">
                        <p>This order is in your waitlist. You should put your waitlist policy in your commission info
                          in your
                          <router-link :to="{name: 'Artist', params: {username: seller.username}}">Artist Settings
                          </router-link>
                          if you have not already, or else add it to the details of the product this order is associated
                          with.
                        </p>
                      </v-col>
                      <v-col v-if="is(NEW) && isBuyer" cols="12">
                        <p>Your order has been placed and is awaiting the artist's review. You will receive an email
                          when the
                          artist has accepted or rejected the order, or if they have any comments.</p>
                        <p>You may add additional comments or questions below!</p>
                      </v-col>
                      <v-col v-if="is(NEW) && isSeller" cols="12">
                        <p>This order is pending your review. Please make any pricing adjustments and accept the order,
                          or
                          reject the order if you are unwilling or unable to complete the piece.</p>
                        <p>You may add comments to ask the commissioner questions.</p>
                      </v-col>
                      <v-col class="text-center" v-if="!is(COMPLETED) && !isRegistered" cols="12">
                        <v-btn color="green" variant="flat" :to="registerLink" class="link-account">Link an Account</v-btn>
                      </v-col>
                      <v-col v-if="is(PAYMENT_PENDING) && isBuyer" cols="12">
                        <v-divider/>
                        <p>
                          <strong>Congratulations!</strong> Your artist has accepted your order. Please submit payment
                          so that it can be added to their work queue.
                          <span v-if="paypalUrl">
                            <a :href="paypalUrl">Payment is done via PayPal.</a> This order is not protected by <router-link
                              :to="{name: 'BuyAndSell', params: {question: 'shield'}}">Artconomy Shield.</router-link>
                          </span>
                          <span
                              v-if="!deliverable.x.escrow_enabled">Your artist will inform you on how to pay them.</span>
                        </p>
                        <p v-if="deliverable.x.escrow_enabled">
                          <strong class="danger">WARNING:</strong> Only send payment using the <strong>'Send
                          Payment'</strong> button in the '<strong>Payment</strong>' <span
                            v-if="$vuetify.display.mdAndUp">tab</span><span v-else>dropdown option</span> directly below
                          this section.
                          Do not use any other method, button, or link, or we will not be able to protect you from
                          fraud. If your
                          artist asks for payment using another method, or if you are getting errors, please <a
                            @click="$store.commit('supportDialog', true)">contact support.</a>
                        </p>
                      </v-col>
                      <v-col
                          v-if="isBuyer && deliverable.x.stream_link && !(is(COMPLETED) || is(CANCELLED) || is(REFUNDED))"
                          cols="12">
                        <p><a :href="deliverable.x.stream_link" target="_blank">Your artist is streaming your commission
                          here!</a></p>
                      </v-col>
                      <v-col v-if="is(PAYMENT_PENDING) && isSeller" cols="12">
                        <p>The commissioner has been informed that they must now pay in order for you to work on the
                          order.
                          You may continue to comment and tweak pricing in the interim, or you may cancel the order if
                          you need to.</p>
                        <p v-if="!deliverable.x.escrow_enabled && !paypalUrl">
                          <strong>REMEMBER:</strong> As we are not handling payment for this order, you MUST tell your
                          commissioner how to pay you. Leave a comment telling them how if you have not done so already.
                          When the customer has paid, click the 'Mark Paid' button.</p>
                        <p v-else-if="!deliverable.x.table_order">
                          You may mark this order as paid, if the customer has paid you through an outside method, or
                          you wish to waive payment for this commission.
                        </p>
                        <v-col class="text-center" v-if="!deliverable.x.escrow_enabled">
                          <v-btn color="primary" variant="flat" @click="statusEndpoint('mark-paid')()">Mark Paid</v-btn>
                        </v-col>
                        <ac-confirmation :action="statusEndpoint('mark-paid')" v-else-if="!deliverable.x.table_order">
                          <template v-slot:default="{on}">
                            <v-col class="text-center" cols="12">
                              <v-btn color="primary" variant="flat" v-on="on">Mark Paid</v-btn>
                            </v-col>
                          </template>
                          <template v-slot:confirmation-text>
                            <v-col>
                              <p>Artconomy will not be able to protect you from fraud if your customer has paid through
                                an outside
                                method.</p>
                              <p><strong>Don't do this unless you really know what you're doing!</strong></p>
                              <p>If you are having trouble, please contact support.</p>
                            </v-col>
                          </template>
                        </ac-confirmation>
                      </v-col>
                      <v-col v-if="isSeller && is(REVIEW)" cols="12">
                        <p>The commissioner has been informed that the final is ready for their review. Please stand by
                          for final approval!</p>
                      </v-col>
                      <v-col v-if="is(REVIEW) && deliverable.x.auto_finalize_on" cols="12">
                        <p>This order will auto-finalize on
                          <strong>{{ formatDateTerse(deliverable.x.auto_finalize_on) }}</strong>.</p>
                      </v-col>
                      <template v-if="isBuyer && is(REVIEW)">
                        <v-col cols="12">
                          <p>Your artist has completed the piece! If all is well, please hit approve. Otherwise, if
                            there is an
                            issue you cannot resolve with the artist, please hit the dispute button.</p>
                        </v-col>
                        <v-row>
                          <v-col class="text-center">
                            <v-btn color="primary" @click="statusEndpoint('approve')()" variant="flat">Approve Final</v-btn>
                          </v-col>
                          <v-col class="text-center">
                            <v-btn color="danger" @click="statusEndpoint('dispute')()" variant="flat">File Dispute</v-btn>
                          </v-col>
                        </v-row>
                      </template>
                      <v-col class="text-center pt-2" cols="12" v-if="isBuyer && is(DISPUTED)">
                        <p><strong>Your dispute has been filed.</strong> Please stand by for further instructions.
                          If you are able to work out your disagreement with the artist, please approve the order using
                          the
                          button below.</p>
                      </v-col>
                      <v-col class="text-center" v-if="(isBuyer || isArbitrator) && is(DISPUTED)" cols="12">
                        <ac-confirmation :action="statusEndpoint('approve')">
                          <template v-slot:default="{on}">
                            <v-btn color="primary" v-on="on">Approve Final</v-btn>
                          </template>
                        </ac-confirmation>
                      </v-col>
                      <v-row v-if="is(WAITING) || is(NEW) || is(PAYMENT_PENDING)">
                        <v-col class="text-center" v-if="is(NEW) && canWaitlist && isSeller">
                          <v-btn color="secondary" @click="statusEndpoint('waitlist')()" variant="flat">Add to Waitlist</v-btn>
                        </v-col>
                        <v-col class="text-center">
                          <ac-confirmation :action="statusEndpoint('cancel')">
                            <template v-slot:default="{on}">
                              <v-btn v-on="on" variant="elevated" color="black">Cancel Order</v-btn>
                            </template>
                          </ac-confirmation>
                        </v-col>
                        <v-col class="text-center">
                          <v-btn
                              color="primary" v-if="$route.params.deliverableId"
                              :to="{name: `${baseName}DeliverablePayment`,
                            params: {...$route.params}}"
                              @click="scrollToSection"
                              variant="flat"
                              class="review-terms-button"
                          >Review Terms/Pricing<span v-if="is(PAYMENT_PENDING) && isBuyer">/Pay</span><span
                              v-else-if="(is(WAITING) || is(NEW)) && isSeller">/Accept</span></v-btn>
                        </v-col>
                        <v-col v-if="isBuyer" class="text-center">
                          <v-btn color="secondary" v-if="$route.params.deliverableId"
                                 variant="flat"
                                 :to="{name: `${baseName}DeliverableReferences`, params: {...$route.params}}">Add
                            References
                          </v-btn>
                        </v-col>
                      </v-row>
                      <v-col v-if="is(QUEUED) && isBuyer" cols="12">
                        <p>Your order has been added to the artists queue. We will notify you when they have begun
                          work!</p>
                      </v-col>
                      <v-col v-if="is(QUEUED) && isSeller" cols="12">
                        <p><strong>Excellent!</strong> The commissioner has paid<span v-if="escrow"> and the money is being held in safekeeping</span>.
                          When you've started work, hit the 'Mark In Progress' button to let the customer know.
                          You can also set the order's streaming link (if applicable) here:</p>
                      </v-col>
                      <v-col
                          v-if="deliverable.x.dispute_available_on && !(is(DISPUTED) || is(REVIEW) || is(COMPLETED) || is(REFUNDED))"
                          cols="12">
                        <p v-if="disputeTimeElapsed">You may file dispute for non-completion if needed.</p>
                        <p v-else>This order may be disputed for non-completion on:
                          <br/><strong>{{ formatDateTerse(deliverable.x.dispute_available_on) }}.</strong></p>
                        <v-col class="text-center">
                          <v-btn v-if="disputeTimeElapsed && isBuyer" @click="statusEndpoint('dispute')()"
                                 color="danger" variant="flat">File Dispute
                          </v-btn>
                        </v-col>
                      </v-col>
                      <v-col v-if="isSeller && (is(QUEUED) || is(IN_PROGRESS) || is(REVIEW) || is(DISPUTED))" cols="12">
                        <v-alert :value="order.x.private">
                          <strong>NOTE:</strong> This user has asked that this commission be private. Please do not use
                          a public streaming link!
                        </v-alert>
                        <ac-patch-field
                            :patcher="deliverable.patchers.stream_link" label="Stream URL">
                        </ac-patch-field>
                      </v-col>
                      <v-col v-if="isBuyer && is(IN_PROGRESS)">
                        <p>The artist has begun work on your order. You'll be notified as they make progress!</p>
                      </v-col>
                      <v-col class="text-center" v-if="is(QUEUED) && isSeller" cols="12">
                        <v-btn color="primary" @click="statusEndpoint('start')()" variant="flat">Mark In Progress</v-btn>
                      </v-col>
                      <v-col v-if="is(DISPUTED) && isSeller">
                        <p><strong>This order is under dispute.</strong> One of our staff will be along soon to give
                          further
                          instruction. If you wish, you may refund the customer. Otherwise, please wait for our staff to
                          work
                          with you and the commissioner on a resolution.</p>
                      </v-col>
                      <v-col class="text-center" v-if="is(COMPLETED)" cols="12">
                        <p>This order has been completed! <strong>Thank you for using Artconomy!</strong></p>
                      </v-col>
                      <v-col class="text-center" v-if="is(COMPLETED) && disputeWindow && isBuyer && deliverable.x.auto_finalize_on" cols="12">
                        <v-alert :value="true" type="info">If there is an issue with this order, please <a href="#"
                          @click.prevent="$store.commit('supportDialog', true)">contact
                          support</a>
                          on or before {{ formatDateTerse(deliverable.x.auto_finalize_on) }}.
                        </v-alert>
                      </v-col>
                      <v-col class="text-center" v-if="is(REFUNDED)" cols="12">
                        <p>This order has been refunded and is now archived.</p>
                      </v-col>
                      <v-col class="text-center" v-if="isSeller && escrow && is(COMPLETED)" cols="12">
                        <p>
                          <router-link :to="{name: 'Payout', params: {username: seller!.username}}">
                            If you have not already, please add your bank account in your payout settings.
                          </router-link>
                        </p>
                        <p>A transfer will automatically be initiated to your bank account.
                          Please wait up to five business days for payment to post.</p>
                      </v-col>
                      <v-col cols="12" v-if="deliverable.x.tip_invoice">
                        <ac-tipping-prompt
                            :invoice-id="deliverable.x.tip_invoice"
                            :source-lines="lineItems"
                            :username="buyer!.username"
                            :deliverable="deliverable"
                            :key="deliverable.x.tip_invoice"
                            :is-buyer="isBuyer"
                        />
                      </v-col>
                      <v-col cols="12" v-if="isBuyer && (is(COMPLETED) || is(REFUNDED))">
                        <ac-deliverable-rating end="seller" :order-id="orderId" :deliverable-id="deliverableId"
                                               key="seller"/>
                      </v-col>
                      <v-col cols="12" v-if="buyer && isSeller && (is(COMPLETED) || is(REFUNDED))">
                        <ac-deliverable-rating end="buyer" :order-id="orderId" :deliverable-id="deliverableId"
                                               key="buyer"/>
                      </v-col>
                      <v-col class="text-center" v-if="isSeller && is(COMPLETED) && !order.x.private" cols="12">
                        <v-img :src="fridge" max-height="20vh" contain/>
                        <v-btn v-if="sellerSubmission" color="primary"
                               variant="flat"
                               :to="{name: 'Submission', params: {submissionId: sellerSubmission.id}}">Visit in
                          Gallery
                        </v-btn>
                        <v-btn color="green" v-else @click="addToGallery" class="gallery-add" variant="elevated">Add to my Gallery</v-btn>
                      </v-col>
                      <v-col class="text-center" v-if="isBuyer && is(COMPLETED)" cols="12">
                        <v-img :src="fridge" max-height="20vh" contain/>
                        <v-btn v-if="buyerSubmission" color="primary"
                               variant="flat"
                               :to="{name: 'Submission', params: {submissionId: buyerSubmission.id}}">Visit in
                          Collection
                        </v-btn>
                        <v-btn color="green" v-else variant="elevated" @click="addToCollection" class="collection-add">Add to Collection
                        </v-btn>
                      </v-col>
                      <v-col v-if="is(CANCELLED) && isBuyer">
                        <p>This order has been cancelled. You will have to create a new order if you want a
                          commission.</p>
                      </v-col>
                      <v-col v-if="is(CANCELLED) && isSeller">
                        <p>This order has been cancelled. There is nothing more to do.</p>
                      </v-col>
                      <v-col v-if="!(is(CANCELLED) || is(REFUNDED) || is(COMPLETED)) && escrow" cols="12">
                        <p><strong class="danger">WARNING:</strong> Any conversations made off-site, such as over
                          instant messanger or text, cannot be viewed or verified by Artconomy staff and will not be
                          considered in the case of a dispute. For your safety, any material discussion should be made
                          via comments on this order. If you must use instant messanger, copy a summary here of your
                          discussion for record, and have the other person affirm it is accurate.</p>
                      </v-col>
                      <ac-form-dialog
                          v-if="is(COMPLETED) || isSeller"
                          @submit.prevent="addSubmission.submitThen(visitSubmission)"
                          v-model="viewSettings.patchers.showAddSubmission.model"
                          v-bind="addSubmission.bind"
                          :sending="addSubmission.sending"
                          :errors="addSubmission.errors"
                          :large="true"
                          :eager="true"
                          class="add-submission-dialog"
                          :title="isSeller ? 'Add to Gallery' : 'Add to Collection'"
                      >
                        <v-container class="pa-0">
                          <v-row no-gutters>
                            <v-col cols="12">
                              <ac-bound-field :field="addSubmission.fields.title" label="Title"/>
                            </v-col>
                            <v-col cols="12">
                              <ac-bound-field
                                  :field="addSubmission.fields.caption"
                                  field-type="ac-editor" :save-indicator="false"
                                  label="Caption"
                                  hint="Tell viewers a little about the piece."
                                  :persistent-hint="true"
                              />
                            </v-col>
                            <v-col cols="12">
                              <ac-bound-field
                                  :field="addSubmission.fields.tags" field-type="ac-tag-field" label="Tags"
                                  hint="Add some tags to make this submission easier to manage. We've added all the tags of
                          the characters attached to this piece (if any) to help!"
                                  :persistent-hint="true"
                              />
                            </v-col>
                            <v-col cols="12" sm="6">
                              <ac-bound-field :field="addSubmission.fields.private" label="Private"
                                              field-type="ac-checkbox"
                                              hint="If checked, will not show this submission to anyone you've not explicitly shared it with."
                              />
                            </v-col>
                            <v-col cols="12" sm="6">
                              <ac-bound-field :field="addSubmission.fields.comments_disabled" label="Comments Disabled"
                                              field-type="ac-checkbox"
                                              hint="If checked, prevents others from commenting on this submission."
                              />
                            </v-col>
                          </v-row>
                        </v-container>
                      </ac-form-dialog>
                      <ac-form-dialog
                          v-if="isSeller && seller"
                          @submit.prevent="newInvoice.submitThen(visitDeliverable)"
                          v-model="viewSettings.patchers.showAddDeliverable.model"
                          v-bind="newInvoice.bind"
                          :large="true"
                          :eager="true"
                          :title="'Add new Deliverable to Order.'"
                      >
                        <v-container class="pa-0">
                          <ac-invoice-form :new-invoice="newInvoice" :username="seller.username"
                                           :line-items="invoiceLineItems" :escrow-enabled="invoiceEscrowEnabled"
                                           :show-buyer="false">
                            <template v-slot:second>
                              <v-col cols="12" sm="6">
                                <v-row no-gutters>
                                  <v-col cols="12" sm="6" md="4" offset-sm="3" offset-md="4">
                                    <ac-bound-field
                                        :field="newInvoice.fields.name"
                                        label="Deliverable Name"
                                        hint="Give this deliverable a name, like 'Page 2' or 'Inks'. This will help distinguish it from the other deliverables in the order."
                                    />
                                  </v-col>
                                </v-row>
                              </v-col>
                              <v-col cols="12" sm="6">
                                <v-checkbox v-model="keepReferences"
                                            label="Keep References"
                                            hint="Carries the references from the current deliverable over to the next one."
                                            :persistent-hint="true"
                                />
                              </v-col>
                              <v-col cols="12" sm="6">
                                <ac-bound-field :field="newInvoice.fields.characters"
                                                :init-items="viewSettings.patchers.characterInitItems.model"
                                                field-type="ac-character-select" label="Characters"
                                                hint="Tag the character(s) to be referenced in this deliverable. If they're not listed on Artconomy, you can skip this step."/>
                              </v-col>
                            </template>
                          </ac-invoice-form>
                        </v-container>
                      </ac-form-dialog>
                    </v-row>
                  </v-card-text>
                </ac-form-container>
              </ac-form>
            </v-card>
          </v-col>
          <v-col cols="12" class="pt-2">
            <v-row no-gutters>
              <v-col v-if="isStaff">
                <v-select
                    v-model="viewMode"
                    :items="viewerItems"
                    label="View as..."
                    outline
                    class="view-mode-select"
                />
              </v-col>
            </v-row>
          </v-col>
        </v-row>
        <v-card>
          <ac-tab-nav :items="navItems" label="See more" />
        </v-card>
        <div class="section-scroll-target"></div>
        <router-view></router-view>
      </v-container>
    </template>
  </ac-load-section>
</template>
<script lang="ts">
import AcLoadSection from '@/components/wrappers/AcLoadSection.vue'
import {Component, mixins, toNative, Watch} from 'vue-facing-decorator'
import Order from '@/types/Order.ts'
import AcProductPreview from '@/components/AcProductPreview.vue'
import AcAsset from '@/components/AcAsset.vue'
import AcLink from '@/components/wrappers/AcLink.vue'
import Formatting from '@/mixins/formatting.ts'
import AcRendered from '@/components/wrappers/AcRendered.ts'
import AcAvatar from '@/components/AcAvatar.vue'
import AcCharacterDisplay from '@/components/views/submission/AcCharacterDisplay.vue'
import AcCommentSection from '@/components/comments/AcCommentSection.vue'
import Ratings from '@/mixins/ratings.ts'
import AcFormContainer from '@/components/wrappers/AcFormContainer.vue'
import AcPatchField from '@/components/fields/AcPatchField.vue'
import AcPricePreview from '@/components/price_preview/AcPricePreview.vue'
import AcConfirmation from '@/components/wrappers/AcConfirmation.vue'
import AcFormDialog from '@/components/wrappers/AcFormDialog.vue'
import AcCardManager from '@/components/views/settings/payment/AcCardManager.vue'
import Submission from '@/types/Submission.ts'
import AcBoundField from '@/components/fields/AcBoundField.ts'
import AcDeliverableRating from '@/components/views/order/AcDeliverableRating.vue'
import AcEscrowLabel from '@/components/AcEscrowLabel.vue'
import {RouteLocationRaw} from 'vue-router'
import AcDeliverableStatus from '@/components/AcDeliverableStatus.vue'
import AcExpandedProperty from '@/components/wrappers/AcExpandedProperty.vue'
import AcForm from '@/components/wrappers/AcForm.vue'
import Deliverable from '@/types/Deliverable.ts'
import DeliverableMixin from './mixins/DeliverableMixin.ts'
import AcTabNav from '@/components/navigation/AcTabNav.vue'
import {VIEWER_TYPE} from '@/types/VIEWER_TYPE.ts'
import LinkedCharacter from '@/types/LinkedCharacter.ts'
import {Character} from '@/store/characters/types/Character.ts'
import AcInvoiceForm from '@/components/views/orders/AcInvoiceForm.vue'
import {SingleController} from '@/store/singles/controller.ts'
import LinkedReference from '@/types/LinkedReference.ts'
import InvoicingMixin from '@/components/views/order/mixins/InvoicingMixin.ts'
import {ListController} from '@/store/lists/controller.ts'
import {BASE_URL, markRead, parseISO} from '@/lib/lib.ts'
import StripeMixin from './mixins/StripeMixin.ts'
import {isBefore} from 'date-fns'
import AcTippingPrompt from '@/components/views/order/deliverable/AcTippingPrompt.vue'
import {ServicePlan} from '@/types/ServicePlan.ts'

@Component({
  components: {
    AcTippingPrompt,
    AcInvoiceForm,
    AcTabNav,
    AcForm,
    AcExpandedProperty,
    AcDeliverableStatus,
    AcEscrowLabel,
    AcDeliverableRating,
    AcBoundField,
    AcCardManager,
    AcFormDialog,
    AcConfirmation,
    AcPricePreview,
    AcPatchField,
    AcFormContainer,
    AcCommentSection,
    AcCharacterDisplay,
    AcAvatar,
    AcRendered,
    AcLink,
    AcAsset,
    AcProductPreview,
    AcLoadSection,
  },
})
class DeliverableDetail extends mixins(DeliverableMixin, Formatting, Ratings, InvoicingMixin, StripeMixin) {
  public parentDeliverables: ListController<Deliverable> = null as unknown as ListController<Deliverable>
  public fridge = new URL('/static/images/fridge.png', BASE_URL).href
  // We only place this on DeliverableDetail so that it doesn't get run multiple times. All subcomponents are
  // reliant on it, however, so keep this in mind during tests.
  @Watch('deliverable.x.id')
  public prePopulate() {
    const deliverable = this.deliverable.x as Deliverable
    const order = deliverable.order as Order
    if (deliverable.arbitrator) {
      this.arbitratorHandler = this.$getProfile(deliverable.arbitrator.username, {})
      this.ensureHandler(this.arbitratorHandler, deliverable.arbitrator)
    }
    this.outputs.setList(deliverable.outputs)
    this.outputs.fetching = false
    this.outputs.ready = true
    this.addSubmission.fields.private.update(order.private)
    this.newInvoice.fields.details.update(deliverable.details)
    this.newInvoice.fields.rating.update(deliverable.rating)
    this.order.setX(order)
    this.order.ready = true
  }

  @Watch('references.list.length')
  public updateReferences(val: number | undefined) {
    /* istanbul ignore if */
    if (val === undefined) {
      return
    }
    this.setReferences()
  }

  public get viewerItems() {
    const items = []
    if (this.viewMode === 0) {
      items.push({
        title: 'Please select...',
        value: VIEWER_TYPE.UNSET,
      })
    }
    items.push({title: 'Staff', value: VIEWER_TYPE.STAFF})
    if (this.buyer) {
      items.push({
        title: 'Buyer',
        value: VIEWER_TYPE.BUYER,
      })
    }
    items.push({
      title: 'Seller',
      value: VIEWER_TYPE.SELLER,
    })
    return items
  }

  public get disputeTimeElapsed() {
    const deliverable = this.deliverable.x as Deliverable
    /* istanbul ignore if */
    if (!deliverable) {
      return false
    }
    if (!deliverable.dispute_available_on) {
      return false
    }
    return isBefore(parseISO(deliverable.dispute_available_on), new Date())
  }

  public visitSubmission(submission: Submission) {
    this.$router.push({
      name: 'Submission',
      params: {submissionId: submission.id + ''},
      query: {editing: 'true'},
    })
  }

  // @ts-ignore
  public get sellerName() {
    if (this.seller) {
      return this.seller.username
    }
    return ''
  }

  public get planName() {
    // eslint-disable-next-line camelcase
    return this.seller?.service_plan || null
  }

  public get registerLink() {
    const order = this.order.x as Order
    const baseRoute: RouteLocationRaw = {
      name: 'Register',
      query: {},
    }
    /* istanbul ignore if */
    if (!order) {
      return baseRoute
    }
    baseRoute.query!.claim = order.claim_token
    /* istanbul ignore next */
    const nextRoute: RouteLocationRaw = {
      name: this.$route.name || undefined,
      params: {...this.$route.params},
      query: {...this.$route.query},
    }
    if (this.is(this.COMPLETED)) {
      nextRoute.query!.showAdd = 'true'
    }
    baseRoute.query!.next = this.$router.resolve(nextRoute).href
    return baseRoute
  }

  public get navItems() {
    const params = {...this.$route.params}
    if (!params.deliverableId) {
      // We're transitioning to another area. Return no items.
      return []
    }
    return [
      {
        value: {
          name: `${this.baseName}DeliverableOverview`,
          params,
        },
        title: 'Overview',
      },
      {
        value: {
          name: `${this.baseName}DeliverableReferences`,
          params,
        },
        title: 'References/Characters',
      },
      {
        value: {
          name: `${this.baseName}DeliverablePayment`,
          params,
        },
        title: 'Payment/Terms',
      },
      {
        value: {
          name: `${this.baseName}DeliverableRevisions`,
          params,
        },
        title: 'Revisions/WIPs',
      },
    ]
  }

  public addToGallery() {
    this.addSubmission.fields.revision.update(null)
    this.viewSettings.model.showAddSubmission = true
  }

  public addToCollection() {
    if (this.isRegistered) {
      this.addSubmission.fields.revision.update(null)
      this.viewSettings.model.showAddSubmission = true
      return
    }
    this.$router.push(this.registerLink)
  }

  public scrollToSection() {
    this.$goTo('.section-scroll-target')
  }

  public visitDeliverable(deliverable: Deliverable) {
    this.order.updateX({deliverable_count: (this.order.x as Order).deliverable_count + 1})
    if (this.parentDeliverables.list.length) {
      this.parentDeliverables.push(deliverable)
    }
    this.$router.push({
      name: `${this.baseName}DeliverableOverview`,
      params: {
        orderId: this.orderId + '',
        deliverableId: deliverable.id + '',
        username: this.$route.params.username,
      },
    })
  }

  public addTags() {
    const tags = []
    const characters = []
    for (const char of this.characters.list) {
      const character = char.x as LinkedCharacter
      tags.push(...character.character.tags)
      characters.push(character.character)
    }
    this.addSubmission.fields.tags.update([...new Set(tags)])
    this.newInvoice.fields.characters.update(characters.map((char: Character) => char.id))
    this.viewSettings.patchers.characterInitItems.model = characters
  }

  public setReferences() {
    this.newInvoice.fields.references.update(
        this.references.list.map((x: SingleController<LinkedReference>) => {
          return x.x && x.x.reference.id
        }),
    )
  }

  // @ts-ignore
  public get international() {
    // Note: This flag is currently used for new invoices based on the current deliverable-- I.E.,
    // multi-stage orders. This assumes the artist has not migrated to or from the US between creating
    // and issuing the next stage. This is such an edge case that I'm leaving this bug in for now,
    // however, it should be addressed when we refactor multi-stage orders to be more intuitive.
    return !!this.deliverable.x?.international
  }

  public get canWaitlist() {
    if (!this.planName) {
      return false
    }
    if (!this.pricing.x) {
      return false
    }
    return this.pricing.x.plans.filter((plan: ServicePlan) => plan.name === this.planName)[0].waitlisting
  }

  // @ts-ignore
  public get invoiceEscrowEnabled() {
    if (!this.sellerHandler) {
      return false
    }
    if (!this.sellerHandler.artistProfile.x) {
      return false
    }
    if (this.newInvoice.fields.paid.value) {
      return false
    }
    return this.sellerHandler.artistProfile.x.escrow_enabled
  }

  public get keepReferences() {
    return Boolean(this.newInvoice.fields.references.value.length)
  }

  // Can't even get this to render during tests :/
  /* istanbul ignore next */
  public set keepReferences(val: boolean) {
    if (val) {
      this.setReferences()
    } else {
      this.newInvoice.fields.references.update([])
    }
  }

  public created() {
    this.deliverable.get().then(() => markRead(this.deliverable, 'sales.Deliverable')).then(
        () => this.parentDeliverables.replace(this.deliverable.x as Deliverable),
    ).catch(this.setError)
    this.characters.firstRun().then(this.addTags)
    this.revisions.firstRun().catch(this.statusOk(403))
    this.references.firstRun()
    // Used when adding the deliverable to keep state sane upstream.
    this.parentDeliverables = this.$getList(
        `order${this.orderId}__deliverables`, {endpoint: `${this.url}deliverables/`},
    )
    this.$listenForList(`${this.prefix}__characters`)
    this.$listenForList(`${this.prefix}__revisions`)
    this.$listenForList(`${this.prefix}__lineItems`)
    this.$listenForSingle(`${this.prefix}__rate__buyer`)
    this.$listenForSingle(`${this.prefix}__rate__seller`)
    this.$listenForSingle(`${this.prefix}__revision.*`)
    this.$listenForSingle('pricing')
    this.$listenForSingle(`${this.prefix}__clientSecret`)
    if (this.$route.query.showAdd) {
      this.viewSettings.patchers.showAddSubmission.model = true
    }
    if (this.$route.name === `${this.baseName}Deliverable`) {
      this.$router.replace({
        name: `${this.baseName}DeliverableOverview`,
        params: {...this.$route.params},
        query: {...this.$route.query},
        hash: this.$route.hash,
      })
    }
    // At the moment, these aren't much benefit, since dropping a file on the uploader immediately submits.
    // But if I change the default behavior, not having these will introduce a subtle bug where the contents will
    // disappear if we navigate away.
    this.$listenForSingle('new-revision-file')
    this.$listenForSingle('new-reference-file')
  }
}

export default toNative(DeliverableDetail)
</script>
